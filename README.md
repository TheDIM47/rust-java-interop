Source: [Mix in Rust with Java (or Kotlin!)](https://tweedegolf.nl/en/blog/147/mix-in-rust-with-java-or-kotlin)
Author: Michiel

## –ö–æ—Ñ–µ —Å –∫—Ä–∞–±–∞–º–∏

`Java` ‚Äî –æ–¥–∏–Ω –∏–∑ –Ω–∞–∏–±–æ–ª–µ–µ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —è–∑—ã–∫–æ–≤ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–π –º—ã –µ—â–µ –Ω–µ –æ–±—Å—É–∂–¥–∞–ª–∏ –≤ –Ω–∞—à–µ–º [Rust Interop Guide](https://tweedegolf.nl/en/interop). –í —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ –º—ã —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º —Ç—Ä–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –º–µ—Ç–æ–¥–∞ –≤—ã–∑–æ–≤–∞ –∫–æ–¥–∞ `Rust` –∏–∑ `Java`: `JNI`, `JNR-FFI` –∏ `Project Panama`. –ú—ã –ø–æ–∫–∞–∂–µ–º —Ä–∞–∑–ª–∏—á–∏—è –º–µ–∂–¥—É —ç—Ç–∏–º–∏ –º–µ—Ç–æ–¥–∞–º–∏ –∏ –ø—Ä–æ–≤–µ–¥–µ–º –±–∞–∑–æ–≤—ã–π –±–µ–Ω—á–º–∞—Ä–∫–∏–Ω–≥ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∏—Ö –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏. –≠—Ç–∏ –º–µ—Ç–æ–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–µ —Ç–æ–ª—å–∫–æ –¥–ª—è `Java`, –Ω–æ –∏ –¥–ª—è –¥—Ä—É–≥–∏—Ö —è–∑—ã–∫–æ–≤ JVM, —Ç–∞–∫–∏—Ö –∫–∞–∫ `Kotlin`. –ó–¥–µ—Å—å –º—ã –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–∏–º—Å—è –Ω–∞ `Java`, –Ω–æ –ø—Ä–∏–º–µ—Ä—ã `Kotlin` –¥–æ—Å—Ç—É–ø–Ω—ã –≤ –≤–µ—Ç–∫–µ [Kotlin](https://github.com/tweedegolf/java-interop/tree/kotlin/src/main/java/golf/tweede) –Ω–∞—à–µ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è [GitHub](https://github.com/tweedegolf/java-interop).

–≠—Ç–∞ —Å—Ç–∞—Ç—å—è —è–≤–ª—è–µ—Ç—Å—è —á–∞—Å—Ç—å—é –Ω–∞—à–µ–≥–æ [Rust Interop Guide](https://tweedegolf.nl/en/interop).

### –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

#### 1. JNI
#### 2. JNR-FFI
#### 3. Project Panama
#### 4. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

### JNI

`Java Native Interface (JNI)` ‚Äî —ç—Ç–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –º–µ—Ç–æ–¥ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è `Java` —Å –Ω–∞—Ç–∏–≤–Ω—ã–º–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞–º–∏. –ù–∞—Ç–∏–≤–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ ‚Äî —ç—Ç–æ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç –≤ `JVM`, –∞ –≤–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ —Å–æ–∑–¥–∞—é—Ç—Å—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —è–∑—ã–∫–∞ —Ç–∏–ø–∞ `C`, `C++` –∏–ª–∏ `Rust`. `JNI` –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–ª—è —Ç–∞–∫–∏—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å–æ —Å—Ä–µ–¥–æ–π `Java` –∏ –¥–æ—Å—Ç—É–ø –∫ –µ–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞–º –¥–∞–Ω–Ω—ã—Ö. [–ö—Ä–µ–π—Ç `JNI`](https://crates.io/crates/jni) –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–∏–ø—ã `Rust` –¥–ª—è —ç—Ç–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞, —á—Ç–æ –¥–µ–ª–∞–µ—Ç —Ä–∞–±–æ—Ç—É —Å `JNI` –≤ `Rust` –æ—á–µ–Ω—å —É–¥–æ–±–Ω–æ–π!

![JNI!](https://github.com/TheDIM47/rust-java-interop/images/jni.jpg "JNI")

#### –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ `Double` –≤ —Å—Ç—Ä–æ–∫—É

–í –∫–∞—á–µ—Å—Ç–≤–µ –ø—Ä–∏–º–µ—Ä–∞ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —á–∏—Å–ª–æ —Ç–∏–ø–∞ `double` (—Ç–∞–∫–∂–µ –∏–∑–≤–µ—Å—Ç–Ω–æ–µ –∫–∞–∫ `f64` –≤ `Rust`) –≤ —Å—Ç—Ä–æ–∫—É. –¢–∞–∫–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–æ–ª–∂–Ω–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ `3.14` –≤ —Å—Ç—Ä–æ–∫—É "3.14". –í Java –º—ã –º–æ–∂–µ–º —Å–¥–µ–ª–∞—Ç—å —ç—Ç–æ, –≤—ã–∑–≤–∞–≤ `Double.toString`, –Ω–æ –¥–∞–≤–∞–π—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–∏–º, —Å–º–æ–∂–µ–º –ª–∏ –º—ã —Å–¥–µ–ª–∞—Ç—å —ç—Ç–æ –±—ã—Å—Ç—Ä–µ–µ, –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–≤ `Rust` –≤ –Ω–∞—à `Java`-–ø—Ä–æ–µ–∫—Ç.

–ò—Å–ø–æ–ª—å–∑—É—è –∫—Ä–µ–π—Ç `JNI`, –º—ã —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é `doubleToStringRust` –∏–∑ –Ω–∞—à–µ–≥–æ –∫–æ–¥–∞ `Rust`, –ø–æ–º–µ—á–∞—è –µ–µ –∫–∞–∫ extern "C":

```rust
#[no_mangle]
pub extern "C" fn Java_golf_tweede_JniInterface_doubleToStringRust(
    env: JNIEnv,
    _class: JClass,
    v: jdouble,
) -> jstring {
    env.new_string(v.to_string()).unwrap().into_raw()
}
```

–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:

- –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏ –∏–º–µ–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–æ–±—â–∞–µ—Ç `JNI`, –≤ –∫–∞–∫–æ–º –∫–ª–∞—Å—Å–µ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è. –í –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ —ç—Ç–æ –∫–ª–∞—Å—Å `JniInterface` –ø–∞–∫–µ—Ç–∞ `golf.tweede`.
- –í —Ç–æ –≤—Ä–µ–º—è –∫–∞–∫ —Ç–∏–ø `jdouble` ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –ø—Å–µ–≤–¥–æ–Ω–∏–º –¥–ª—è `f64`, —Ç–∏–ø `jstring` ‚Äî —ç—Ç–æ –æ–±—ä–µ–∫—Ç `Java`, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ `JNI`-–æ–∫—Ä—É–∂–µ–Ω–∏–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —É–¥–æ–±–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é-–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä. –ú—ã –∫–æ–º–ø–∏–ª–∏—Ä—É–µ–º –∫–æ–¥ Rust –≤ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É, –∏—Å–ø–æ–ª—å–∑—É—è —Ç–∏–ø –∫—Ä–µ–π—Ç–∞ `cdylib` –≤ `Cargo.toml`:

```toml
[package]
name = "java-interop"
version = "0.1.0"
edition = "2021"

[lib]
crate-type = ["cdylib"]
```

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —Å–±–æ—Ä–∫–∏ —Å –ø–æ–º–æ—â—å—é `cargo build --release` –≤—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å —Ñ–∞–π–ª `libjava_interop.so` –≤ –ø–∞–ø–∫–µ `target/release`, –µ—Å–ª–∏ –≤—ã —Ä–∞–±–æ—Ç–∞–µ—Ç–µ –≤ `Linux`. –í `Windows` –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ `Rust` –±—É–¥–µ—Ç —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–∞ –≤ —Ñ–∞–π–ª `.dll` –≤–º–µ—Å—Ç–æ —Ñ–∞–π–ª–∞ `.so`, –∞ –≤ `MacOS` —ç—Ç–æ –±—É–¥–µ—Ç —Ñ–∞–π–ª `.dylib`.

–¢–µ–ø–µ—Ä—å –º—ã –º–æ–∂–µ–º –æ–±—ä—è–≤–∏—Ç—å –Ω–∞—à—É —Ñ—É–Ω–∫—Ü–∏—é `doubleToStringRust` –≤ –∫–ª–∞—Å—Å–µ `JniInterface` –ø–∞–∫–µ—Ç–∞ `golf.tweede` –∫–∞–∫ –Ω–∞—Ç–∏–≤–Ω—É—é –∏ –≤—ã–∑–≤–∞—Ç—å, –∑–∞–≥—Ä—É–∑–∏–≤ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É —á–µ—Ä–µ–∑ `System.load`:

```java
package golf.tweede;

import java.nio.file.Path;
import java.nio.file.Paths;

public class JniInterface {
    public static native String doubleToStringRust(double v);

    static {
        Path p = Paths.get("src/main/rust/target/release/libjava_interop.so");
        System.load(p.toAbsolutePath().toString()); // load library
    }
    
    public static void main(String[] args) {
        System.out.println(doubleToStringRust(0.123)); // this prints "0.123"!
    }
}
```

–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ, –æ–∂–∏–¥–∞–µ—Ç—Å—è —á—Ç–æ –Ω–∞—à–∞ –Ω–∞—Ç–∏–≤–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –±—É–¥–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–π –ø–∞–ø–∫–µ. –í –∫–∞—á–µ—Å—Ç–≤–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã –≤—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—ã–∑–æ–≤ `System.loadLibrary` (`java_interop`) –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∏–∑ –æ–¥–Ω–æ–π –∏–∑ –ø–∞–ø–æ–∫ –≤ `java.library.path`, –∫–æ—Ç–æ—Ä–∞—è –≤ `Linux` –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ `/usr/java/packages/lib`, `/usr/lib64`, `/lib64`, `/lib` –∏ `/usr/lib`. –ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ —É–ø–∞–∫–æ–≤–∞—Ç—å —Å–≤–æ–π –ø—Ä–æ–µ–∫—Ç `Java` –≤ `JAR`, –≤–∞–º –≤—Å–µ —Ä–∞–≤–Ω–æ –ø—Ä–∏–¥–µ—Ç—Å—è —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –º–µ—Å—Ç–µ, –ª–∏–±–æ –≤–∫–ª—é—á–∏–≤ –µ–µ –≤ `JAR` –∏ –∏–∑–≤–ª–µ–∫–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫—É –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π, –ª–∏–±–æ —É—Å—Ç–∞–Ω–æ–≤–∏–≤ –µ–µ –æ—Ç–¥–µ–ª—å–Ω–æ.

#### –ò–∑–º–µ—Ä–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

–ß—Ç–æ–±—ã —Å—Ä–∞–≤–Ω–∏—Ç—å –Ω–∞—à—É –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Å–≤—è–∑–∞–Ω–Ω—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é `Rust` —Å `Double.toString` –≤—ã–∑–æ–≤–æ–º `Java`, –º—ã –∑–∞–ø—É—Å—Ç–∏–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–µ—Å—Ç–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `JMH`. –ú—ã —Å–æ–∑–¥–∞–¥–∏–º —Ñ—É–Ω–∫—Ü–∏–∏, –∞–Ω–Ω–æ—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ `@Benchmark`, –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:

```java
@Benchmark
public String doubleToStringJavaBenchmark(BenchmarkState state) {
    return Double.toString(state.value);
}

@Benchmark
public String doubleToStringRustBenchmark(BenchmarkState state) {
    return doubleToStringRust(state.value);
}   
```

–ú—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º –≤—Ö–æ–¥–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∫–ª–∞—Å—Å `BenchmarkState`, —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É—é—Ç—Å—è –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–æ–º `Java` –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –≤—Ö–æ–¥–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è:

```java
@State(Scope.Benchmark)
public static class BenchmarkState {
    public double value = Math.PI;
}
```

–ï—Å–ª–∏ –º—ã —Å–æ–±–µ—Ä–µ–º –ø—Ä–æ–µ–∫—Ç —Å –ø–æ–º–æ—â—å—é `mvn clean verify`, —Ç–æ —Å–º–æ–∂–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∫–æ–º–∞–Ω–¥–æ–π `java -jar target/benchmarks.jar -f 1`. –í–æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:

```
Benchmark                                  Mode  Cnt         Score        Error  Units
Main.doubleToStringJavaBenchmark          thrpt    5  29921713.259 ¬± 576120.424  ops/s
JniInterface.doubleToStringRustBenchmark  thrpt    5   5401499.220 ¬±  23625.065  ops/s 
```

–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —á—Ç–æ `Java`-—Ñ—É–Ω–∫—Ü–∏—è –ø–æ—á—Ç–∏ –≤ 6 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ —Ñ—É–Ω–∫—Ü–∏–∏ `JNI` `Rust`. –≠—Ç–∞ —Ä–∞–∑–Ω–∏—Ü–∞ –≤ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤—ã–∑–≤–∞–Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –Ω–∞–∫–ª–∞–¥–Ω—ã–º–∏ —Ä–∞—Å—Ö–æ–¥–∞–º–∏ –ø—Ä–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏ —Å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–æ–π.

#### –£—Å–∫–æ—Ä–µ–Ω–∏–µ

–î–∞–≤–∞–π—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–∏–º, —Å–º–æ–∂–µ–º –ª–∏ –º—ã –¥–æ–±–∏—Ç—å—Å—è –±–æ–ª—å—à–µ–≥–æ. –î–ª—è –Ω–∞—á–∞–ª–∞, –≤–º–µ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ `Rust` `to_string`, –≤–æ—Å–ø–æ–ª—å–∑—É–µ–º—Å—è –∫—Ä–µ–π—Ç–æ–º `Ryu`, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ö–∏—Ç—Ä—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è —á–∏—Å–µ–ª —Å –ø–ª–∞–≤–∞—é—â–µ–π —Ç–æ—á–∫–æ–π –≤ —Å—Ç—Ä–æ–∫–∏ –¥–æ 5 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ!

–í–æ—Ç –Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è `Rust JNI`, –∫–æ—Ç–æ—Ä–∞—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `Ryu` –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è —á–∏—Å–µ–ª –¥–≤–æ–π–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏ –≤ —Å—Ç—Ä–æ–∫–∏:

```rust
#[no_mangle]
pub extern "C" fn Java_golf_tweede_JniInterface_doubleToStringRyu(
    env: JNIEnv,
    _class: JClass,
    value: jdouble,
) -> jstring {
    let mut buffer = ryu::Buffer::new();
    env.new_string(buffer.format(value)).unwrap().into_raw()
}
```

–¢–µ–ø–µ—Ä—å –¥–∞–≤–∞–π—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –±–µ–Ω—á–º–∞—Ä–∫–∞. –ú—ã –ø—Ä–µ–≤—Ä–∞—Ç–∏–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –∫—Ä–∞—Å–∏–≤—É—é —Å—Ç–æ–ª–±—á–∞—Ç—É—é –¥–∏–∞–≥—Ä–∞–º–º—É –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:

![Ryu benchmark!](https://github.com/TheDIM47/rust-java-interop/images/ryu-performance.jpg "Ryu benchmark")

–≠—Ç–æ—Ç –∫–æ–¥ –ø—Ä–∏–º–µ—Ä–Ω–æ –Ω–∞ `50%` –±—ã—Å—Ç—Ä–µ–µ, —á–µ–º –Ω–∞—à–∞ –∏—Å—Ö–æ–¥–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è `Rust`, –Ω–æ –ø–æ–∫–∞ –µ—â–µ –Ω–µ –ø—Ä–∏–±–ª–∏–∂–∞–µ—Ç—Å—è –∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ `Java`-–∫–æ–¥–∞.

#### –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ —á–∏—Å–µ–ª double —Å –ø–æ–º–æ—â—å—é –º–∞—Å—Å–∏–≤–æ–≤

–í—Å–µ –µ—â–µ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤ –ø—Ä–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏ —Å –Ω–∞—à–µ–π –Ω–∞—Ç–∏–≤–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–æ–π. –ú—ã –º–æ–∂–µ–º —É–º–µ–Ω—å—à–∏—Ç—å —ç—Ç–∏ –Ω–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã, –≤—ã–ø–æ–ª–Ω—è—è –±–æ–ª—å—à–µ —Ä–∞–±–æ—Ç—ã –∑–∞ –≤—ã–∑–æ–≤ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ `Rust`. –í–º–µ—Å—Ç–æ —Ç–æ–≥–æ, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ —á–∏—Å–ª–æ `double` –∫–∞–∂–¥—ã–π —Ä–∞–∑, –∫–æ–≥–¥–∞ –º—ã –≤—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é, –º—ã –º–æ–∂–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –º–∞—Å—Å–∏–≤, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –º–Ω–æ–≥–æ —á–∏—Å–µ–ª `double` –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ, –∏ –∑–∞—Å—Ç–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –≤—Å–µ —á–∏—Å–ª–∞ `double` –≤ —Å—Ç—Ä–æ–∫—É —Å –ø—Ä–æ–±–µ–ª–∞–º–∏ –º–µ–∂–¥—É –∑–Ω–∞—á–µ–Ω–∏—è–º–∏. –•–æ—Ç—è —ç—Ç–æ –Ω–µ–º–Ω–æ–≥–æ —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –±—É–¥–µ—Ç –æ—á–µ–Ω—å –ø–æ–ª–µ–∑–µ–Ω –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ, –æ–Ω –ø–æ–∑–≤–æ–ª–∏—Ç –Ω–∞–º –ø—Ä–æ–¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å, –∫–∞–∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É–ª—É—á—à–∞–µ—Ç—Å—è –ø—Ä–∏ –±–æ–ª—å—à–∏—Ö —Ä–∞–±–æ—á–∏—Ö –Ω–∞–≥—Ä—É–∑–∫–∞—Ö.

–ù–∞ —Å—Ç–æ—Ä–æ–Ω–µ `Java` –æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é `doubleArrayToStringRyu`:

```java
public static native String doubleArrayToStringRyu(double[] v);
```

–í –Ω–∞—à–µ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–µ `Rust` –º—ã —Ä–µ–∞–ª–∏–∑—É–µ–º –µ–µ —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:

```rust
#[no_mangle]
pub extern "C" fn Java_golf_tweede_JniInterface_doubleArrayToStringRyu(
    mut env: JNIEnv,
    _class: JClass,
    array: JDoubleArray,
) -> jstring {
    let mut buffer = ryu::Buffer::new();
    let len: usize = env.get_array_length(&array).unwrap().try_into().unwrap();
    let mut output = String::with_capacity(10 * len);

    {
        let elements = unsafe {
            env.get_array_elements_critical(&array, ReleaseMode::NoCopyBack)
                .unwrap()
        };

        for v in elements.iter() {
            output.push_str(buffer.format(*v)); // add number to output string
            output.push(' ');
        }
    }

    env.new_string(output).unwrap().into_raw()
}
```

–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:

- `Double[]` —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è `JDoubleArray`, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ –º—ã –¥–æ–ª–∂–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `env` –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–ª–∏–Ω—ã –∏ –µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤. –ü–æ—Å–∫–æ–ª—å–∫—É —ç—Ç–æ—Ç –º–∞—Å—Å–∏–≤ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–∞–∫ –≤—Ö–æ–¥–Ω–æ–π, –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º `ReleaseMode::NoCopyBack`, —á—Ç–æ–±—ã —Å–æ–æ–±—â–∏—Ç—å `JNI`, —á—Ç–æ –µ–º—É –Ω–µ –Ω—É–∂–Ω–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –æ–±—Ä–∞—Ç–Ω–æ, –Ω–∞ —Å—Ç–æ—Ä–æ–Ω—É `Java`.
- –ú—ã —Å–æ–∑–¥–∞–µ–º –≤—ã—Ö–æ–¥–Ω—É—é —Å—Ç—Ä–æ–∫—É —Å –±–æ–ª—å—à–æ–π –µ–º–∫–æ—Å—Ç—å—é, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –µ–π –Ω–µ –ø—Ä–∏–¥–µ—Ç—Å—è –ø–µ—Ä–µ–∞–ª–ª–æ—Ü–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–∫ –º–Ω–æ–≥–æ –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ –≤ –Ω–µ–µ –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–∏–º–≤–æ–ª–æ–≤.

–ß—Ç–æ–±—ã –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —ç—Ç—É –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é, –º—ã –¥–æ–±–∞–≤–ª—è–µ–º –º–∞—Å—Å–∏–≤ –∏–∑ 1 –º–∏–ª–ª–∏–æ–Ω–∞ `double` –≤ –Ω–∞—à–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:

```java
@State(Scope.Benchmark)
public static class BenchmarkState {
    public double value = Math.PI;
    public double[] array = new double[1_000_000];

    @Setup
    public void setup() {
        for (int i = 0; i < array.length; i++) {
            array[i] = i / 12f;
        }
    }
}
```

–ê —Ç–µ–ø–µ—Ä—å –º—ã –æ–ø—Ä–µ–¥–µ–ª–∏–º –±–µ–Ω—á–º–∞—Ä–∫–∏ –¥–ª—è –Ω–∞—à–µ–π —Ñ—É–Ω–∫—Ü–∏–∏ `Rust` `JNI` –∏ —Ñ—É–Ω–∫—Ü–∏–∏, –Ω–∞–ø–∏—Å–∞–Ω–Ω–æ–π —Ç–æ–ª—å–∫–æ –Ω–∞ `Java`, –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:

```java
@Benchmark
public String doubleArrayToStringRyuBenchmark(BenchmarkState state) {
    return doubleArrayToStringRyu(state.array);
}

@Benchmark
public String doubleArrayToStringJavaBenchmark(BenchmarkState state) {
    return String.join(" ", DoubleStream.of(state.array).mapToObj(Double::toString).toArray(String[]::new));
}
```

–î–∞–≤–∞–π—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–∏–º, –∫–∞–∫ –æ–Ω–∏ —Å–µ–±—è –ø–æ–∫–∞–∂—É—Ç:

![Ryu array!](https://github.com/TheDIM47/rust-java-interop/images/ryu-performance-double-array.jpg "Ryu array")

–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞ —ç—Ç–æ! –¢–µ–ø–µ—Ä—å –Ω–∞—à–∞ —Ñ—É–Ω–∫—Ü–∏—è `Java JNI Rust` –ø–æ—á—Ç–∏ –≤ –¥–≤–∞ —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ —Ñ—É–Ω–∫—Ü–∏–∏, –Ω–∞–ø–∏—Å–∞–Ω–Ω–æ–π —Ç–æ–ª—å–∫–æ –Ω–∞ `Java`! üòé

–ö–æ–Ω–µ—á–Ω–æ, –º–æ–∂–Ω–æ –±—ã–ª–æ –±—ã –∏ –¥–∞–ª—å—à–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥, –Ω–∞–ø–∏—Å–∞–Ω–Ω—ã–π —Ç–æ–ª—å–∫–æ –Ω–∞ `Java`. –û–¥–Ω–∞–∫–æ —ç—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞—Ö –º–æ–∂–µ—Ç –±—ã—Ç—å —Ü–µ–ª–µ—Å–æ–æ–±—Ä–∞–∑–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–∞—Ç–∏–≤–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –ø—Ä–∏ –≤—ã–∑–æ–≤–µ.

### JNR-FFI

–¢–µ–ø–µ—Ä—å –¥–∞–≤–∞–π—Ç–µ —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º –¥—Ä—É–≥–æ–π –º–µ—Ç–æ–¥ –≤—ã–∑–æ–≤–∞ –Ω–∞—Ç–∏–≤–Ω—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫ –∏–∑ `Java`: [`JNR-FFI`](https://github.com/jnr/jnr-ffi). –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç `JNI`, `JNR-FFI` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ–±—â–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `C` –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –Ω–∞—Ç–∏–≤–Ω—ã–º–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞–º–∏. –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –Ω–∞–º –Ω–µ –Ω—É–∂–Ω–æ –ø–∏—Å–∞—Ç—å —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π –¥–ª—è `JNI` –∫–æ–¥ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ `Rust`, –Ω–∞–º –Ω–µ –Ω—É–∂–Ω–æ –≤–∫–ª—é—á–∞—Ç—å –∫–∞–∫–∏–µ-–ª–∏–±–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∏–º–µ–Ω–∞ –∫–ª–∞—Å—Å–æ–≤ –∏ –ø–∞–∫–µ—Ç–æ–≤ `Java` –≤ –∏–º–µ–Ω–∞ –Ω–∞—à–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π, –∞ `JNR-FFI` –ø–æ–∑–∞–±–æ—Ç–∏—Ç—Å—è –æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–∏ –º–µ–∂–¥—É —Ç–∏–ø–∞–º–∏ `C` –∏ —Ç–∏–ø–∞–º–∏ `Java`.

`JNR-FFI` –ø–æ—Ö–æ–∂–∞ –Ω–∞ [`JNA`](https://github.com/java-native-access/jna), –¥—Ä—É–≥—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É `Java` –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –Ω–∞—Ç–∏–≤–Ω—ã–º–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞–º–∏. –û–¥–Ω–∞–∫–æ `JNR-FFI` [–±–æ–ª–µ–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø—Ä–µ–≤–æ—Å—Ö–æ–¥–Ω—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å](https://github.com/jnr/jnr-ffi/blob/master/docs/ComparisonToSimilarProjects.md#jna-java-native-access), –ø–æ—ç—Ç–æ–º—É –º—ã —Ä–µ—à–∏–ª–∏ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å `JNR-FFI` –≤–º–µ—Å—Ç–æ `JNA`.

![JNR-FFI!](https://github.com/TheDIM47/rust-java-interop/images/jnr-ffi.jpg "JNR-FFI")

–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤–∏–º `JNR-FFI` –≤ –Ω–∞—à –ø—Ä–æ–µ–∫—Ç, –≤–∫–ª—é—á–∏–≤ –µ–≥–æ –∫–∞–∫ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å `Maven` –≤ `pom.xml` (–¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π `Rust`: `pom.xml` –¥–ª—è `Maven` –ø–æ—Ö–æ–∂ –Ω–∞ `Cargo.toml`, –Ω–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ `XML`):

```xml
<dependency>
  <groupId>com.github.jnr</groupId>
  <artifactId>jnr-ffi</artifactId>
  <version>2.2.17</version>
</dependency>
```

–¢–µ–ø–µ—Ä—å –¥–∞–≤–∞–π—Ç–µ —Ä–µ–∞–ª–∏–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é `doubleToStringRust` –≤ `Rust` —Å —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º `C` –≤–º–µ—Å—Ç–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ `JNI`, –∫–æ—Ç–æ—Ä—ã–π –º—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ —Ä–∞–Ω–µ–µ:

```rust
use std::ffi::{c_char, c_double, CString};

#[no_mangle]
pub extern "C" fn doubleToStringRust(value: c_double) -> *mut c_char {
    CString::new(value.to_string()).unwrap().into_raw()
}
```

–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:

- –¢–µ–ø–µ—Ä—å –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–∏–ø—ã `C` –∏–∑ `std::ffi` –≤–º–µ—Å—Ç–æ —Ç–∏–ø–æ–≤ `Java JNI`.
- –ß—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å —Å—Ç—Ä–æ–∫—É —á–µ—Ä–µ–∑ `C`-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –º—ã —Å–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–µ–º `C`-—Å—Ç—Ä–æ–∫—É, –∫–æ—Ç–æ—Ä–∞—è –∑–∞—Ç–µ–º –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫–∞–∫ —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ —Å–∏–º–≤–æ–ª —Å –ø–æ–º–æ—â—å—é `into_raw`.

–ù–∞ —Å—Ç–æ—Ä–æ–Ω–µ `Java` –º—ã —Å–Ω–∞—á–∞–ª–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å —Ñ—É–Ω–∫—Ü–∏—è–º–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ–∞–ª–∏–∑—É–µ—Ç –Ω–∞—à–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ `Rust`:

```java
public interface RustLib {
    String doubleToStringRust(double value);
}
```

–ò –∑–∞—Ç–µ–º –º—ã –∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—à—É –±–∏–±–ª–∏–æ—Ç–µ–∫—É –∏—Å–ø–æ–ª—å–∑—É—è –∫–ª–∞—Å—Å `LibraryLoader` –∏–∑ –ø–∞–∫–µ—Ç–∞ `JNR`.

```java
public static RustLib lib;

static {
    System.setProperty("jnr.ffi.library.path", "src/main/rust/target/release");
    lib = LibraryLoader.create(RustLib.class).load("java_interop"); // load library
}
```

–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ, –∑–¥–µ—Å—å –º—ã –≥–æ–≤–æ—Ä–∏–º –µ–º—É –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ–ª—å–∫–æ `java_interop` –≤–º–µ—Å—Ç–æ –ø–æ–ª–Ω–æ–≥–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ `libjava_interop.so`. `JNR-FFI` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –µ–≥–æ –≤ –ø–æ–ª–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–±–∏—Ä–∞—Ç—å –º–µ–∂–¥—É —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è–º–∏ —Ñ–∞–π–ª–æ–≤ `.so`, `.dll` –∏–ª–∏ `.dylib` –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–π –æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç, —á—Ç–æ —É–ø—Ä–æ—â–∞–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫—Ä–æ—Å—Å-–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏!

#### –û –Ω–µ—Ç! –£—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏!

–ú—ã –ø–æ—à–ª–∏ –¥–∞–ª—å—à–µ –∏ —Ç–∞–∫–∂–µ –¥–æ–±–∞–≤–∏–ª–∏ `Ryu` –∏ —Ñ—É–Ω–∫—Ü–∏–∏ –º–∞—Å—Å–∏–≤–∞ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –≤ –Ω–∞—à –Ω–æ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å. –§—É–Ω–∫—Ü–∏—è –º–∞—Å—Å–∏–≤–∞ —Ç–µ–ø–µ—Ä—å —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∫–∞–∫ `doubleArrayToStringRyu(array: *const c_double, len: usize)` –≤ `Rust`, –∏ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º `std::slice::from_raw_parts` –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–∞–π—Å–∞ `&[f64]`:

```rust
#[no_mangle]
pub unsafe extern "C" fn doubleArrayToStringRyu(array: *const c_double, len: usize) -> *mut c_char {
    let slice = std::slice::from_raw_parts(array, len);
    ...
    CString::new(output).unwrap().into_raw()
}    
```

–ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –∑–∞–ø—É—Å–∫–∞ –±–µ–Ω—á–º–∞—Ä–∫–æ–≤ –¥–ª—è —ç—Ç–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π –º—ã –∑–∞–º–µ—Ç–∏–ª–∏ –Ω–µ—á—Ç–æ —Å—Ç—Ä–∞–Ω–Ω–æ–µ: –±–µ–Ω—á–º–∞—Ä–∫–∏ –∑–∞–º–µ–¥–ª—è—é—Ç—Å—è –ø–æ—Å–ª–µ –ø–∞—Ä—ã –∏—Ç–µ—Ä–∞—Ü–∏–π. –ï—Å–ª–∏ –º—ã –ø–æ—Å–º–æ—Ç—Ä–∏–º –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ –≤–æ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–∞, —Ç–æ —É–≤–∏–¥–∏–º, –ø–æ—á–µ–º—É:

![Memory leak!](imag[s/mem]()ory-leak.png "Memory leak")

–ö—Ä–∞—Å–Ω–∞—è –ª–∏–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–±—â–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏, —Ç–∞–∫ —á—Ç–æ, –ø–æ—Ö–æ–∂–µ, —É –Ω–∞—Å –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –ø–∞–º—è—Ç—å!

–ï—Å–ª–∏ –º—ã –ø–æ—Å–º–æ—Ç—Ä–∏–º –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –Ω–∞ `CString::into_raw`, —Ç–æ —É–≤–∏–¥–∏–º, —á—Ç–æ –Ω–∞–º –Ω—É–∂–Ω–æ –≤—Ä—É—á–Ω—É—é  –≤—ã–∑–≤–∞—Ç—å `CString::from_raw`, —á—Ç–æ–±—ã –æ—Å–≤–æ–±–æ–¥–∏—Ç—å –ø–∞–º—è—Ç—å –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `into_raw`. –í –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è –º—ã —ç—Ç–æ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º. –ü–∞–º—è—Ç—å –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç—Å—è —á—Ç–æ –∏ –æ–±—ä—è—Å–Ω—è–µ—Ç –Ω–∞—à—É —É—Ç–µ—á–∫—É –ø–∞–º—è—Ç–∏.

–ß—Ç–æ–±—ã –∏—Å–ø—Ä–∞–≤–∏—Ç—å —ç—Ç–æ, –º—ã –¥–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≤ –Ω–∞—à—É —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É `Rust`, –∫–æ—Ç–æ—Ä–∞—è –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç `CString` —Å –ø–æ–º–æ—â—å—é `from_raw`:

```rust
#[no_mangle]
pub unsafe extern "C" fn freeString(string: *mut c_char) {
    let _ = CString::from_raw(string);
}
```

–ß—Ç–æ–±—ã –≤—ã–∑–≤–∞—Ç—å —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é, –Ω–∞–º –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –Ω–∞—à –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ `Java`. –†–∞–Ω—å—à–µ –Ω–∞—à–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–ª–∏ —Å—Ç—Ä–æ–∫–∏ `Java`. –≠—Ç–æ –æ–∑–Ω–∞—á–∞–ª–æ, —á—Ç–æ `JNR-FFI` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç `char`-—É–∫–∞–∑–∞—Ç–µ–ª–∏ `C` –≤ —Å—Ç—Ä–æ–∫–∏ `Java`. –û–¥–Ω–∞–∫–æ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è —Å—Ç—Ä–æ–∫ `C` –Ω–∞–º –Ω—É–∂–µ–Ω –¥–æ—Å—Ç—É–ø –∫ –∏—Å—Ö–æ–¥–Ω—ã–º `C`-—É–∫–∞–∑–∞—Ç–µ–ª—è–º. –ü–æ—ç—Ç–æ–º—É –º—ã –∑–∞—Å—Ç–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ `Java` –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —É–∫–∞–∑–∞—Ç–µ–ª–∏ –≤–º–µ—Å—Ç–æ —Å—Ç—Ä–æ–∫:

```java
public interface RustLib {
    Pointer doubleToStringRust(double value);
    Pointer doubleToStringRyu(double value);
    Pointer doubleArrayToStringRyu(double[] array, int len);
    void freeString(Pointer string);
}
```

–ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Å—Ç—Ä–æ–∫–∏ –∏–∑ —ç—Ç–∏—Ö —É–∫–∞–∑–∞—Ç–µ–ª–µ–π, –º—ã –º–æ–∂–µ–º –Ω–∞–ø–∏—Å–∞—Ç—å —É–¥–æ–±–Ω—É—é –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è —Ç–∞–∫–∂–µ –±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å `freeString` –¥–ª—è –Ω–∞—Å:

```java
public static String pointerToString(Pointer pointer) {
    String string = pointer.getString(0);
    lib.freeString(pointer); // frees the original C string
    return string;
}
```

–ò—Å–ø–æ–ª—å–∑—É—è —ç—Ç—É –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é, –º—ã –±–æ–ª—å—à–µ –Ω–µ —Ç–µ—Ä—è–µ–º –ø–∞–º—è—Ç—å!

#### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

–¢–µ–ø–µ—Ä—å, –∫–æ–≥–¥–∞ –º—ã –∏—Å–ø—Ä–∞–≤–∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å –ø–∞–º—è—Ç—å—é, –¥–∞–≤–∞–π—Ç–µ —Å—Ä–∞–≤–Ω–∏–º –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –º–µ–∂–¥—É `JNR-FFI` –∏ `JNI`.
–í–æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –º—ã –ø–æ–ª—É—á–∏–ª–∏ –¥–ª—è `doubleToString`:

![JNI vs JNR-FFI!](https://github.com/TheDIM47/rust-java-interop/images/double-to-string-jnr.jpg "JNI vs JNR-FFI")

–ê –≤–æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è `doubleArrayToString`:

![JNI vs JNR-FFI array!](https://github.com/TheDIM47/rust-java-interop/images/double-array-to-string-jnr.jpg "JNI vs JNR-FFI array")

–ö–∞–∫ –≤–∏–¥–µ—Ç–µ, `JNR-FFI`, –ø–æ—Ö–æ–∂–µ, –Ω–µ–º–Ω–æ–≥–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ `JNI`. –•–æ—Ç—è –ø—Ä–∏—è—Ç–Ω–æ, —á—Ç–æ `JNR-FFI` –º–æ–∂–µ—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º `C` –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–∏—Å–∞—Ç—å —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π –¥–ª—è `JNI` –∫–æ–¥, —ç—Ç–æ –≤–ª–µ—á–µ—Ç –∑–∞ —Å–æ–±–æ–π –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã.

### Project Panama

–ü–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Ç–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –º—ã –æ–±—Å—É–¥–∏–º, ‚Äî `Project Panama`. `Project Panama` ‚Äî —ç—Ç–æ –Ω–æ–≤–µ–π—à–∏–π —Å–ø–æ—Å–æ–± –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –Ω–∞—Ç–∏–≤–Ω—ã–º–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞–º–∏ `Java`, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤ `OpenJDK`. –ü–æ—Å–∫–æ–ª—å–∫—É –æ–Ω –≤—Å–µ –µ—â–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ, –¥–ª—è –Ω–µ–≥–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è `JDK`; –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º `OpenJDK 23`. –ü–æ–¥–æ–±–Ω–æ `JNR-FFI`, –æ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `C`. –û–¥–Ω–∞–∫–æ, –≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç `JNR-FFI`, `Project Panama` –º–æ–∂–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ `Java`.

![Project Paname!](https://github.com/TheDIM47/rust-java-interop/images/project-panama.jpg "Project Panama")

–ß—Ç–æ–±—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –±–∏–Ω–¥–∏–Ω–≥–∏ `Java` –¥–ª—è –Ω–∞—à–µ–≥–æ –∫–æ–¥–∞ `Rust`, –º—ã —Å–Ω–∞—á–∞–ª–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ñ–∞–π–ª –∑–∞–≥–æ–ª–æ–≤–∫–∞ `C` —Å –ø–æ–º–æ—â—å—é `cbindgen`. –ó–∞—Ç–µ–º –º—ã –º–æ–∂–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `jextract` –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ `Java` –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ `C`.

–í—ã –º–æ–∂–µ—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `cbindgen` —Å –ø–æ–º–æ—â—å—é `cargo`:

```bashl
cargo install --force cbindgen
```

–°–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `jextract` ‚Äî —Å –ø–æ–º–æ—â—å—é `SDKMAN`:

```bashl
sdk use java 23-open
sdk install jextract
```

–¢–µ–ø–µ—Ä—å –º—ã –º–æ–∂–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç—å `cbindgen` –≤ –Ω–∞—à–µ–º –ø—Ä–æ–µ–∫—Ç–µ `Rust` –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–∞–≥–æ–ª–æ–≤–æ—á–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ `java_interop.h`:

```bashl
cbindgen --lang c --output bindings/java_interop.h
```

–¢–µ–ø–µ—Ä—å –º—ã –º–æ–∂–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç—å `jextract` –≤ –Ω–∞—à–µ–º –ø—Ä–æ–µ–∫—Ç–µ `Java` —Å –ø–æ–º–æ—â—å—é —Å–ª–µ–¥—É—é—â–µ–π –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ `Java`-–±–∏–Ω–¥–∏–Ω–≥–æ–≤:

```bashl
jextract \
  --include-dir src/main/rust/bindings/ \
  --output src/main/java \
  --target-package golf.tweede.gen \
  --library :src/main/rust/target/release/libjava_interop.so \
  src/main/rust/bindings/java_interop.h
```

–í –∫–∞—á–µ—Å—Ç–≤–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã –º—ã –º–æ–∂–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—à–∏ –±–∏–Ω–¥–∏–Ω–≥–∏, –¥–æ–±–∞–≤–∏–≤ —Å–∫—Ä–∏–ø—Ç `build.rs` –≤ –Ω–∞—à `Rust`-–ø—Ä–æ–µ–∫—Ç. –°–∫—Ä–∏–ø—Ç –±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å `cbindgen` –∏ `jextract`:

```rust
fn main() {
    // Create C headers with cbindgen
    let crate_dir = std::env::var("CARGO_MANIFEST_DIR").unwrap();
    cbindgen::Builder::new()
        .with_crate(crate_dir.clone())
        .with_language(cbindgen::Language::C)
        .generate()
        .unwrap()
        .write_to_file("bindings/java_interop.h");

    // Create Java interface with JExtract
    let java_project_dir = std::path::Path::new(&crate_dir).ancestors().nth(3).unwrap();
    std::process::Command::new("jextract")
        .current_dir(java_project_dir)
        .arg("--include-dir")
        .arg("src/main/rust/bindings/")
        .arg("--output")
        .arg("src/main/java")
        .arg("--target-package")
        .arg("golf.tweede.gen")
        .arg("--library")
        .arg(":src/main/rust/target/release/libjava_interop.so")
        .arg("src/main/rust/bindings/java_interop.h")
        .spawn()
        .unwrap();
}
```

–ï—Å–ª–∏ —Ç–µ–ø–µ—Ä—å –º—ã —Å–æ–±–µ—Ä–µ–º –Ω–∞—à `Rust`-–ø—Ä–æ–µ–∫—Ç, —Ç–æ —É–≤–∏–¥–∏–º, —á—Ç–æ –≤ –ø–∞–ø–∫–µ `bindings` –ø–æ—è–≤–∏–ª—Å—è —Ñ–∞–π–ª `java_interop.h`, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ `C` –¥–ª—è –Ω–∞—à–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π `Rust`. –ú—ã —Ç–∞–∫–∂–µ —É–≤–∏–¥–∏–º, –∫–∞–∫ –≤ `src/main/java/golf/tweede/gen` –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤ `Java`. –§–∞–π–ª, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞—Å –∑–¥–µ—Å—å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç, ‚Äî —ç—Ç–æ `java_interop_h.java`, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–¥–µ—Ä–∂–∏—Ç `Java`-–±–∏–Ω–¥–∏–Ω–≥–∏ –¥–ª—è –Ω–∞—à–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π `Rust` –≤ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∫ –º–Ω–æ–∂–µ—Å—Ç–≤—É –¥—Ä—É–≥–∏—Ö –±–∏–Ω–¥–∏–Ω–≥–æ–≤ –Ω–∞—Ç–∏–≤–Ω—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫.

–ü–æ—Å–∫–æ–ª—å–∫—É `Project Panama` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `C`, –º—ã –¥–æ–ª–∂–Ω—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ—Å–≤–æ–±–æ–¥–∏–ª–∏ –Ω–∞—à–∏ —Å—Ç—Ä–æ–∫–∏, –∏–Ω–∞—á–µ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç —É—Ç–µ—á–∫–∞ –ø–∞–º—è—Ç–∏, —Å –∫–æ—Ç–æ—Ä–æ–π –º—ã —É–∂–µ —Å—Ç–æ–ª–∫–Ω—É–ª–∏—Å—å –≤ —Ä–∞–∑–¥–µ–ª–µ `JNR-FFI`. –ü–æ —ç—Ç–æ–π –ø—Ä–∏—á–∏–Ω–µ –±–∏–Ω–¥–∏–Ω–≥–∏ –∏–∑ `Project Panama` –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç —Å–µ–≥–º–µ–Ω—Ç –ø–∞–º—è—Ç–∏ –≤–º–µ—Å—Ç–æ —Å—Ç—Ä–æ–∫–∏. –ú—ã —Å–Ω–æ–≤–∞ –Ω–∞–ø–∏—à–µ–º –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é, —á—Ç–æ–±—ã –∏–∑–≤–ª–µ—á—å —Å—Ç—Ä–æ–∫—É –∏–∑ —ç—Ç–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞ –ø–∞–º—è—Ç–∏ –∏ –æ—Å–≤–æ–±–æ–¥–∏—Ç—å –∏—Å—Ö–æ–¥–Ω—É—é `C`-—Å—Ç—Ä–æ–∫—É, –≤—ã–∑–≤–∞–≤ –Ω–∞—à –º–µ—Ç–æ–¥ `freeString`:

```java
private static String segmentToString(MemorySegment segment) {
    String string = segment.getString(0);
    java_interop_h.freeString(segment);
    return string;
}

public static String doubleToStringRust(double value) {
    return segmentToString(java_interop_h.doubleToStringRust(value));
}

public static String doubleToStringRyu(double value) {
    return segmentToString(java_interop_h.doubleToStringRyu(value));
}
```

–î–∞–≤–∞–π—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–∏–º, –∫–∞–∫ `Project Panama` –≤—ã–≥–ª—è–¥–∏—Ç –≤ –±–µ–Ω—á–º–∞—Ä–∫–∞—Ö: 

![Project Panama benchmark!](https://github.com/TheDIM47/rust-java-interop/images/double-to-string-all.jpg "Project Panama benchmark")

–•–æ—Ç—è `Project Panama` –≤—Å–µ –µ—â–µ –Ω–∞–º–Ω–æ–≥–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ, —á–µ–º –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–∞—Ç–∏–≤–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏, –æ–Ω –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –ª—É—á—à—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å `JNI` –∏ `JNR-FFI`!

#### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–∞—Å—Å–∏–≤–æ–≤: —Å–æ–≤–º–µ—Å—Ç–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏

–î–ª—è —Å–ª–µ–¥—É—â–µ–≥–æ –±–µ–Ω—á–º–∞—Ä–∫–∞ –º—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–º –º–∞—Å—Å–∏–≤ `double` –¥–ª—è –Ω–∞—à–µ–≥–æ `Rust`-–∫–æ–¥–∞. –î–ª—è —ç—Ç–æ–≥–æ –Ω–∞–º –Ω—É–∂–Ω–æ –≤—ã–¥–µ–ª–∏—Ç—å —Å–µ–≥–º–µ–Ω—Ç `off-heap`-–ø–∞–º—è—Ç–∏ —Å –ø–æ–º–æ—â—å—é `API` `Foreign Function & Memory` (`FFM`). –°–Ω–∞—á–∞–ª–∞ –º—ã –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—É—é –∞—Ä–µ–Ω—É —Å –ø–æ–º–æ—â—å—é `Arena.ofConfined()`. –≠—Ç–∞ –∞—Ä–µ–Ω–∞ –±—É–¥–µ—Ç –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ –≤—ã–¥–µ–ª—è–µ–º–æ–π –Ω–∞–º–∏ –ø–∞–º—è—Ç–∏. –ó–∞—Ç–µ–º –º—ã –≤—ã–¥–µ–ª—è–µ–º —Å–µ–≥–º–µ–Ω—Ç –ø–∞–º—è—Ç–∏ –¥–ª—è –Ω–∞—à–µ–≥–æ –º–∞—Å—Å–∏–≤–∞ `double` —Å –ø–æ–º–æ—â—å—é `allocateFrom` –∏ –ø–µ—Ä–µ–¥–∞–µ–º –µ–≥–æ –≤ –Ω–∞—à –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `Rust`:

```java
public static String doubleArrayToStringRyu(double[] array) {
    String output;
    try (Arena offHeap = Arena.ofConfined()) {
        // allocate off-heap memory for input array
        MemorySegment segment = offHeap.allocateFrom(ValueLayout.JAVA_DOUBLE, array);
        output = segmentToString(java_interop_h.doubleArrayToStringRyu(segment, array.length));
    } // release memory for input array
    return output;
}
```

–í—ã–¥–µ–ª–µ–Ω–Ω—ã–π —Å–µ–≥–º–µ–Ω—Ç –ø–∞–º—è—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç—Å—è –∞—Ä–µ–Ω–æ–π, –∫–∞–∫ —Ç–æ–ª—å–∫–æ –º—ã –¥–æ—Å—Ç–∏–≥–∞–µ–º –∫–æ–Ω—Ü–∞ –±–ª–æ–∫–∞ `try`.

–î–∞–≤–∞–π—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–∏–º, –∫–∞–∫ —Ñ—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –º–∞—Å—Å–∏–≤–∞ –≤ `Project Panama` –≤—ã–≥–ª—è–¥–∏—Ç –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –¥—Ä—É–≥–∏–º–∏ –º–µ—Ç–æ–¥–∞–º–∏:

![Project Panama array!](https://github.com/TheDIM47/rust-java-interop/images/double-array-to-string-all.jpg "Project Panama array")

#### –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

- –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ –Ω–∞—Ç–∏–≤–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –Ω–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å. –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –µ—Å–ª–∏ –≤—ã –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç–µ –º–Ω–æ–≥–æ –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç–µ –º–Ω–æ–≥–æ –¥–æ—Ä–æ–≥–æ—Å—Ç–æ—è—â–∏—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `FFI` –æ–±—ã—á–Ω–æ –Ω–µ –æ–ø—Ä–∞–≤–¥—ã–≤–∞–µ—Ç —Å–µ–±—è —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏. –û–¥–Ω–∞–∫–æ `FFI` –≤—Å–µ —Ä–∞–≤–Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω—ã–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–º –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –∫ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞–º –∏–∑ –¥—Ä—É–≥–∏—Ö —è–∑—ã–∫–æ–≤ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è –∏–ª–∏ –¥–ª—è –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ –±–æ–ª—å—à–æ–π –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã –Ω–∞ –¥—Ä—É–≥–æ–π —è–∑—ã–∫, –Ω–∞–ø—Ä–∏–º–µ—Ä `Rust`.
- `JNI` —Ç—Ä–µ–±—É–µ—Ç –æ—Ç –Ω–∞—Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç–∏–ø–æ–≤ `Java` –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ `Rust` –∏ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å–æ —Å—Ä–µ–¥–æ–π `Java` —á–µ—Ä–µ–∑ –µ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å. –•–æ—Ç—è —ç—Ç–æ —Ç—Ä–µ–±—É–µ—Ç –æ—Ç –Ω–∞—Å –Ω–∞–ø–∏—Å–∞–Ω–∏—è —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ–≥–æ –¥–ª—è `JNI` –∫–æ–¥–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ `Rust`, —ç—Ç–æ –¥–µ–ª–∞–µ—Ç —É–¥–æ–±–Ω–æ–π —Ä–∞–±–æ—Ç—É —Å –æ–±—ä–µ–∫—Ç–∞–º–∏ `Java`, —Ç–∞–∫–∏–º–∏ –∫–∞–∫ –º–∞—Å—Å–∏–≤—ã, –∏ –¥–∞–µ—Ç –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ —Ç–µ–º, –∫–∞–∫ –º—ã –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ–º —Å–æ —Å—Ä–µ–¥–æ–π `Java`. 
- –° –¥—Ä—É–≥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã, `JNR-FFI` –∏ `Project Panama` –∏—Å–ø–æ–ª—å–∑—É—é—Ç —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `C` –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ `Rust`. –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –Ω–∞–º –Ω–µ –ø—Ä–∏–¥–µ—Ç—Å—è –ø–∏—Å–∞—Ç—å —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π –¥–ª—è `Java` –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, —á—Ç–æ —É–ø—Ä–æ—â–∞–µ—Ç —Ä–∞–±–æ—Ç—É —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞–º–∏, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `C`. –û–¥–Ω–∞–∫–æ —ç—Ç–æ —Ç–∞–∫–∂–µ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –Ω–∞–º —Å–ª–µ–¥—É–µ—Ç –±—ã—Ç—å –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã–º–∏ —Å —Ç–µ–º, –∫–∞–∫ –º—ã —É–ø—Ä–∞–≤–ª—è–µ–º –ø–∞–º—è—Ç—å—é –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ `Java`, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å —É—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏.
- –ò–∑ —Ç—Ä–µ—Ö –æ–ø—Ä–æ–±–æ–≤–∞–Ω–Ω—ã—Ö –Ω–∞–º–∏ –º–µ—Ç–æ–¥–æ–≤ `Project Panama` –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–∞–∏–ª—É—á—à—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å. –û–Ω —Ç–∞–∫–∂–µ —É–¥–æ–±–µ–Ω –≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —Å –µ–≥–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –±–∏–Ω–¥–∏–Ω–≥–∞–º–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `cbindgen` –∏ `jextract`. `Project Panama` –≤—Å–µ –µ—â–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –∏ —Ç—Ä–µ–±—É–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏ `JDK`, —á—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–æ–º –¥–ª—è –ø—Ä–æ–µ–∫—Ç–æ–≤ `Java`, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞—Å—Ç—Ä—è–ª–∏ –Ω–∞ —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏—è—Ö `JDK`.
- –ú—ã –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ `Project Panama` —Å—Ç–∞–Ω–µ—Ç –æ—Å–Ω–æ–≤–Ω—ã–º –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã–º –º–µ—Ç–æ–¥–æ–º `FFI` –¥–ª—è `Java`. –•–æ—Ç—è —Ä–∞–±–æ—Ç–∞ —Å —Ç–∏–ø–∞–º–∏ `C` –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–º –Ω–µ—É–¥–æ–±—Å—Ç–≤–æ–º, –ø—Ä–æ–±–ª–µ–º—ã —Å –ø–∞–º—è—Ç—å—é, –∫–æ—Ç–æ—Ä—ã–µ –æ–Ω–∏ –ø—Ä–∏–Ω–æ—Å—è—Ç, –º–æ–∂–Ω–æ —Ä–µ—à–∏—Ç—å —Å –ø–æ–º–æ—â—å—é –Ω–µ–±–æ–ª—å—à–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π-–æ–±–æ–ª–æ—á–µ–∫. –í –∏–¥–µ–∞–ª–µ –≤ –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ –±—ã–ª–æ –±—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, —Ç–∞–∫–æ–π –∫–∞–∫ `CXX` (–∫–∞–∫ –ø–æ–∫–∞–∑–∞–Ω–æ –≤ –Ω–∞—à–µ–º –±–ª–æ–≥–µ –ø–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—é —Å `C++`), –∫–æ—Ç–æ—Ä—ã–π –æ–±—ä–µ–¥–∏–Ω–∏—Ç `cbindgen` –∏ `jextract` –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –º–µ–∂–¥—É `Rust` –∏ `Java`. –ù–æ –Ω–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –∏ `JNI`, –∏ `Project Panama` —É–∂–µ –ø—Ä–µ–¥–ª–∞–≥–∞—é—Ç –æ—Ç–ª–∏—á–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ `Rust` –≤ –≤–∞—à –ø—Ä–æ–µ–∫—Ç `Java` –∏–ª–∏ `Kotlin`.
- –ö–æ–¥, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –±–µ–Ω—á–º–∞—Ä–∫–æ–≤, –æ–±—Å—É–∂–¥–∞–µ–º—ã—Ö –≤ —ç—Ç–æ–º –±–ª–æ–≥–µ, –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ [`GitHub`](https://github.com/tweedegolf/java-interop). –í –±—É–¥—É—â–µ–º –º—ã, –≤–æ–∑–º–æ–∂–Ω–æ, —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º [`UniFFI`](https://mozilla.github.io/uniffi-rs/), –µ—â–µ –æ–¥–∏–Ω –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –±–∏–Ω–¥–∏–Ω–≥–æ–≤ `FFI` –∏–∑ `Rust` –¥–ª—è `Kotlin` –∏ –¥—Ä—É–≥–∏—Ö —è–∑—ã–∫–æ–≤ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è.

---
UPD: –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏—Å—Ö–æ–¥–Ω–∏–∫–∏ –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ [–∑–¥–µ—Å—å](https://github.com/TheDIM47/rust-java-interop)

–ú–æ–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –±–µ–Ω—á–º–∞—Ä–∫–æ–≤:
```text
Benchmark                        Mode  Cnt         Score        Error  Units
RustInterop.array_java          thrpt    5        15.139 ¬±      2.866  ops/s
RustInterop.array_jni_ryu       thrpt    5        26.159 ¬±      0.131  ops/s
RustInterop.array_jnr_ryu       thrpt    5        21.668 ¬±      0.154  ops/s
RustInterop.array_panama_ryu    thrpt    5        26.246 ¬±      0.305  ops/s
RustInterop.single_java         thrpt    5  32594101.758 ¬± 253602.485  ops/s
RustInterop.single_jni_rust     thrpt    5   6540231.996 ¬±  50037.771  ops/s
RustInterop.single_jni_ryu      thrpt    5  10774582.479 ¬±  36451.296  ops/s
RustInterop.single_jnr_rust     thrpt    5   6337482.189 ¬±  40620.226  ops/s
RustInterop.single_jnr_ryu      thrpt    5  10142990.195 ¬±  77541.522  ops/s
RustInterop.single_panama_rust  thrpt    5   9215584.675 ¬±  69872.847  ops/s
RustInterop.single_panama_ryu   thrpt    5  18705611.014 ¬± 148834.842  ops/s
```
